<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Elastic-job by dangdangdotcom</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Elastic-job</h1>
      <h2 class="project-tagline">Elastic-Job is a distributed scheduled job framework, based on Quartz and Curator.</h2>
      <a href="https://github.com/dangdangdotcom/elastic-job" class="btn">View on GitHub</a>
      <a href="https://github.com/dangdangdotcom/elastic-job/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/dangdangdotcom/elastic-job/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
<h2>
<a id="theory_illustrate" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Theory illustrate</h2>

<ul>
<li>
<p><strong>Theory for elastic and distributed</strong></p>

<ol>
<li><p>First job server online will trigger leader server election. If leader server offline will trigger re-election, during election the main thread will be blocked.</p></li>
<li><p>Job servers online will register server info into registry center automatically; job servers offline will update status.</p></li>
<li><p>Leader server election, job servers online or offline, sharding total count changes will update re-sharding flag.</p></li>
<li><p>When triggert scheduled task and need re-sharding, leader server sharding, other servers are blocked. Execute task must wait for sharding complete. If leader server crashed during sharding, will trigger leader election, and then sharing again.</p></li>
<li><p>During job executing, for stable reason, only flag, but not re-sharding. Sharind only occur at next task trigger.</p></li>
<li><p>Every sharding result will sort by IP address to make sure sharding result consistent.</p></li>
<li><p>Failover feature, when job server complete own task will pull orphan task items; one job server offline also trigger other idle job servers pull orphan task items.</p></li>
</ol>
</li>
<li>
<p><strong>Data structure for registry center</strong></p>

<p>Registry center will create znode by job name in indicated namespace to difference jobs. Job znode includes 4 sub znodes: config, servers, execution and leader.</p>

<p><strong>Overview</strong></p>
</li>
</ul>

<p><img src="images/reg_center.jpg" alt="Data structure for registry center"></p>

<p><strong>config node</strong></p>

<p>Global configuration info for job</p>

<table>
<tbody>
<tr>
<td><em>Znode name</em></td>
<td><em>Ephemeral</em></td>
<td><em>Description</em></td>
</tr>
<tr>
<td>jobClass</td>
<td>N</td>
<td>Job class name</td>
</tr>
<tr>
<td>shardingTotalCount</td>
<td>N</td>
<td>Sharding total count</td>
</tr>
<tr>
<td>cron</td>
<td>N</td>
<td>CRON expression for job start</td>
</tr>
<tr>
<td>shardingItemParameters</td>
<td>N</td>
<td>Map for sharing item numbers and customized parameters</td>
</tr>
<tr>
<td>jobParameter</td>
<td>N</td>
<td>Job parameter for one job context</td>
</tr>
<tr>
<td>monitorExecution</td>
<td>N</td>
<td>Enable/disable monitor execution status</td>
</tr>
<tr>
<td>processCountIntervalSeconds</td>
<td>N</td>
<td>Job process count statistics interval seconds</td>
</tr>
<tr>
<td>concurrentDataProcessThreadCount</td>
<td>N</td>
<td>Max threads number for data concurrent process</td>
</tr>
<tr>
<td>fetchDataCount</td>
<td>N</td>
<td>Data fetch count for per fetch process</td>
</tr>
<tr>
<td>failover</td>
<td>N</td>
<td>Enable/disable failover</td>
</tr>
<tr>
<td>description</td>
<td>N</td>
<td>Description for job</td>
</tr>
</tbody>
</table>

<p><strong>servers node</strong></p>

<p>Job server info, sub node is server IP address. The sub nodes of IP address save server details. Same job server only can run one same job instance.</p>

<table>
<tbody>
<tr>
<td><em>Znode name</em></td>
<td><em>Ephemeral</em></td>
<td><em>Description</em></td>
</tr>
<tr>
<td>hostName</td>
<td>N</td>
<td>Server name</td>
</tr>
<tr>
<td>status</td>
<td>Y</td>
<td>Server status, include READY and RUNNING.<br>Use to indicate server is waiting or execution job.<br>If no status node means server offline now</td>
</tr>
<tr>
<td>disabled</td>
<td>N</td>
<td>Enable/disable Server status.<br>Usually disable during publish jobs for multiple servers.</td>
</tr>
<tr>
<td>sharding</td>
<td>N</td>
<td>Assigned sharding items to this server.<br>Multiple sharding items use comma to split.<br>Example: 0,1,2 means this server assigned 1, 2 and 3 sharding items.</td>
</tr>
<tr>
<td>processSuccessCount</td>
<td>N</td>
<td>Statistics process success in a period of time.<br>Interval can configure at config\processCountIntervalSeconds</td>
</tr>
<tr>
<td>processFailureCount</td>
<td>N</td>
<td>Statistics process failure in a period of time.<br>Interval can configure at config\processCountIntervalSeconds</td>
</tr>
<tr>
<td>stoped</td>
<td>N</td>
<td>Job stop flag</td>
</tr>
</tbody>
</table>

<p><strong>execution node</strong></p>

<p>Execution info, sub node is sharding items number, start from zero, max is sharding total count minus one. Can disable record execution info at config\monitorExecution</p>

<table>
<tbody>
<tr>
<td><em>Znode name</em></td>
<td><em>Ephemeral</em></td>
<td><em>Description</em></td>
</tr>
<tr>
<td>running</td>
<td>Y</td>
<td>Running status of this sharing item.<br>If this znode is not existed, and don't have completed znode, it means this sharding item is not run yet.</td>
</tr>
<tr>
<td>completed</td>
<td>N</td>
<td>Complete status of this sharing item.<br>Will clean when next trigger.</td>
</tr>
<tr>
<td>failover</td>
<td>Y</td>
<td>If this sharding item is assigned to other server by failover, here will record server IP address for real execution.</td>
</tr>
<tr>
<td>lastBeginTime</td>
<td>N</td>
<td>Last begin time for this sharding item</td>
</tr>
<tr>
<td>nextFireTime</td>
<td>N</td>
<td>Next fire time for this sharding item</td>
</tr>
<tr>
<td>lastCompleteTime</td>
<td>N</td>
<td>Last complete time for this sharding item</td>
</tr>
</tbody>
</table>

<p><strong>leader node</strong></p>

<p>Leader server info, include election, sharding and execution, use to leader election, sharding and executing processing.</p>

<p>leader znode is an internal znode, if not interested for implement details, please ignore.</p>

<table>
<tbody>
<tr>
<td><em>Znode name</em></td>
<td><em>Ephemeral</em></td>
<td><em>Description</em></td>
</tr>
<tr>
<td>election\host</td>
<td>Y</td>
<td>Leader server IP address<br>If this znode is removed will trigger leader re-election.<br>During election main thread will block.</td>
</tr>
<tr>
<td>election\latch</td>
<td>N</td>
<td>Distributed lock for leader election.<br>Used by Curator.</td>
</tr>
<tr>
<td>sharding\necessary</td>
<td>N</td>
<td>Sharding flag.<br>Sharding total count changes, servers online or offline and leader election will trigger it.</td>
</tr>
<tr>
<td>sharding\processing</td>
<td>Y</td>
<td>When sharing by leader server, will hold this znode.<br>If existed, all jobs will block until sharding completed.<br>When sharding completed or leader server crashed, this znode will be removed.</td>
</tr>
<tr>
<td>execution\necessary</td>
<td>N</td>
<td>Fix execution info flag.<br>If sharding total count changes, will trigger it.<br>Elastic-Job will increase or decrease sharding numbers.</td>
</tr>
<tr>
<td>execution\cleaning</td>
<td>Y</td>
<td>When cleaning previous completed status by leader server, will hold this znode.<br>Trigger every new task fired.<br><br>If existed, all jobs will block until cleaning completed.<br>When cleaning completed or leader server crashed, this znode will be removed.</td>
</tr>
<tr>
<td>failover\items\0(itemNumber)</td>
<td>N</td>
<td>Fill sharding item to this znode when their job server crashed.<br>If some job servers idel, will pull sharing items from here.</td>
</tr>
<tr>
<td>failover\items\latch</td>
<td>N</td>
<td>Distributed lock for assign failover shadring items.<br>Used by Curator.</td>
</tr>
</tbody>
</table>

<ul>
<li>
<p><strong>Flow chart</strong></p>

<p>Job start</p>

<p><img src="images/job_start.jpg" alt="Job start"></p>

<p>Job execution</p>

<p><img src="images/job_exec.jpg" alt="Job execution"></p>
</li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/dangdangdotcom/elastic-job">Elastic-job</a> is maintained by <a href="https://github.com/dangdangdotcom">dangdangdotcom</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("elastic-job");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
